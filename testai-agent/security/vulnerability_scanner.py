"""
TestAI Agent - Vulnerability Scanner

Identifies potential security vulnerabilities based on page type
and generates corresponding test requirements.
"""

from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import List, Dict, Any, Optional, Set
import re


class VulnerabilityType(Enum):
    """OWASP-aligned vulnerability types."""
    # OWASP Top 10 2021
    BROKEN_ACCESS_CONTROL = "A01:2021"
    CRYPTOGRAPHIC_FAILURES = "A02:2021"
    INJECTION = "A03:2021"
    INSECURE_DESIGN = "A04:2021"
    SECURITY_MISCONFIGURATION = "A05:2021"
    VULNERABLE_COMPONENTS = "A06:2021"
    AUTH_FAILURES = "A07:2021"
    INTEGRITY_FAILURES = "A08:2021"
    LOGGING_FAILURES = "A09:2021"
    SSRF = "A10:2021"

    # Additional common vulnerabilities
    XSS = "XSS"
    CSRF = "CSRF"
    SESSION_FIXATION = "SESSION_FIXATION"
    SENSITIVE_DATA_EXPOSURE = "SENSITIVE_DATA"
    BRUTE_FORCE = "BRUTE_FORCE"
    RATE_LIMITING = "RATE_LIMITING"


class SeverityLevel(Enum):
    """Severity levels for vulnerabilities."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


@dataclass
class Vulnerability:
    """A potential vulnerability identified."""
    id: str
    vulnerability_type: VulnerabilityType
    severity: SeverityLevel
    title: str
    description: str
    affected_component: str
    owasp_reference: str
    test_required: str
    remediation: str
    confidence: float = 0.8
    cwe_id: Optional[str] = None
    cvss_score: Optional[float] = None


@dataclass
class ScanResult:
    """Result of a security scan."""
    page_type: str
    feature: str
    scanned_at: datetime
    vulnerabilities: List[Vulnerability] = field(default_factory=list)
    total_found: int = 0
    critical_count: int = 0
    high_count: int = 0
    medium_count: int = 0
    low_count: int = 0
    risk_score: float = 0.0


class VulnerabilityScanner:
    """
    Scans page types for potential vulnerabilities and generates
    security testing requirements.
    """

    # Vulnerability definitions by page type
    VULNERABILITY_MAP = {
        "login": [
            {
                "type": VulnerabilityType.INJECTION,
                "severity": SeverityLevel.CRITICAL,
                "title": "SQL Injection in Authentication",
                "description": "Login forms may be vulnerable to SQL injection through username/password fields",
                "component": "Authentication Form",
                "owasp": "A03:2021 - Injection",
                "test": "Test SQL injection payloads in login fields",
                "remediation": "Use parameterized queries or ORM, validate input",
                "cwe": "CWE-89",
            },
            {
                "type": VulnerabilityType.XSS,
                "severity": SeverityLevel.HIGH,
                "title": "XSS in Login Error Messages",
                "description": "Error messages may reflect user input without sanitization",
                "component": "Error Display",
                "owasp": "A03:2021 - Injection",
                "test": "Test XSS payloads in login fields, verify sanitization in errors",
                "remediation": "Sanitize all output, use Content-Security-Policy",
                "cwe": "CWE-79",
            },
            {
                "type": VulnerabilityType.BRUTE_FORCE,
                "severity": SeverityLevel.HIGH,
                "title": "Brute Force Attack Vulnerability",
                "description": "Login may allow unlimited authentication attempts",
                "component": "Authentication Endpoint",
                "owasp": "A07:2021 - Auth Failures",
                "test": "Test rate limiting after multiple failed attempts",
                "remediation": "Implement rate limiting, account lockout, CAPTCHA",
                "cwe": "CWE-307",
            },
            {
                "type": VulnerabilityType.SESSION_FIXATION,
                "severity": SeverityLevel.MEDIUM,
                "title": "Session Fixation Risk",
                "description": "Session ID may not be regenerated after login",
                "component": "Session Management",
                "owasp": "A07:2021 - Auth Failures",
                "test": "Verify session ID changes after successful login",
                "remediation": "Regenerate session ID on authentication",
                "cwe": "CWE-384",
            },
            {
                "type": VulnerabilityType.CSRF,
                "severity": SeverityLevel.MEDIUM,
                "title": "CSRF on Login Form",
                "description": "Login form may lack CSRF protection",
                "component": "Login Form",
                "owasp": "A01:2021 - Broken Access Control",
                "test": "Verify CSRF token presence and validation",
                "remediation": "Implement CSRF tokens on all forms",
                "cwe": "CWE-352",
            },
            {
                "type": VulnerabilityType.SENSITIVE_DATA_EXPOSURE,
                "severity": SeverityLevel.MEDIUM,
                "title": "Credential Exposure in Logs",
                "description": "Passwords may be logged in plaintext",
                "component": "Logging System",
                "owasp": "A09:2021 - Logging Failures",
                "test": "Verify passwords are not logged or exposed in errors",
                "remediation": "Never log sensitive data, mask passwords",
                "cwe": "CWE-312",
            },
        ],
        "signup": [
            {
                "type": VulnerabilityType.INJECTION,
                "severity": SeverityLevel.CRITICAL,
                "title": "SQL Injection in Registration",
                "description": "Registration fields may be vulnerable to SQL injection",
                "component": "Registration Form",
                "owasp": "A03:2021 - Injection",
                "test": "Test SQL injection in all registration fields",
                "remediation": "Use parameterized queries, validate all input",
                "cwe": "CWE-89",
            },
            {
                "type": VulnerabilityType.XSS,
                "severity": SeverityLevel.HIGH,
                "title": "Stored XSS via User Profile",
                "description": "User-submitted data may be stored and displayed without sanitization",
                "component": "User Profile Storage",
                "owasp": "A03:2021 - Injection",
                "test": "Test XSS payloads in profile fields, verify sanitization on display",
                "remediation": "Sanitize input on storage, escape output on display",
                "cwe": "CWE-79",
            },
            {
                "type": VulnerabilityType.AUTH_FAILURES,
                "severity": SeverityLevel.HIGH,
                "title": "Weak Password Requirements",
                "description": "Registration may allow weak passwords",
                "component": "Password Validation",
                "owasp": "A07:2021 - Auth Failures",
                "test": "Test minimum password requirements enforcement",
                "remediation": "Enforce strong password policy (length, complexity)",
                "cwe": "CWE-521",
            },
            {
                "type": VulnerabilityType.INSECURE_DESIGN,
                "severity": SeverityLevel.MEDIUM,
                "title": "Account Enumeration",
                "description": "Different responses may reveal if email/username exists",
                "component": "Registration Response",
                "owasp": "A04:2021 - Insecure Design",
                "test": "Compare responses for existing vs non-existing accounts",
                "remediation": "Use generic responses, rate limit registration",
                "cwe": "CWE-204",
            },
            {
                "type": VulnerabilityType.RATE_LIMITING,
                "severity": SeverityLevel.MEDIUM,
                "title": "Mass Registration Vulnerability",
                "description": "Registration endpoint may lack rate limiting",
                "component": "Registration Endpoint",
                "owasp": "A05:2021 - Security Misconfiguration",
                "test": "Test rate limiting on registration submissions",
                "remediation": "Implement rate limiting, CAPTCHA",
                "cwe": "CWE-799",
            },
        ],
        "checkout": [
            {
                "type": VulnerabilityType.INJECTION,
                "severity": SeverityLevel.CRITICAL,
                "title": "SQL Injection in Order Processing",
                "description": "Order/payment fields may be vulnerable to injection",
                "component": "Order Processing",
                "owasp": "A03:2021 - Injection",
                "test": "Test SQL injection in all checkout fields",
                "remediation": "Use parameterized queries, strict input validation",
                "cwe": "CWE-89",
            },
            {
                "type": VulnerabilityType.BROKEN_ACCESS_CONTROL,
                "severity": SeverityLevel.CRITICAL,
                "title": "Price Manipulation",
                "description": "Client-side price values may be manipulated",
                "component": "Price Calculation",
                "owasp": "A01:2021 - Broken Access Control",
                "test": "Test price modification in requests, verify server-side validation",
                "remediation": "Always calculate prices server-side, validate totals",
                "cwe": "CWE-472",
            },
            {
                "type": VulnerabilityType.SENSITIVE_DATA_EXPOSURE,
                "severity": SeverityLevel.CRITICAL,
                "title": "Payment Card Data Exposure",
                "description": "Payment card data may not be properly protected",
                "component": "Payment Processing",
                "owasp": "A02:2021 - Cryptographic Failures",
                "test": "Verify PCI-DSS compliance, check data encryption",
                "remediation": "Use PCI-compliant payment processor, never store full card data",
                "cwe": "CWE-311",
            },
            {
                "type": VulnerabilityType.CSRF,
                "severity": SeverityLevel.HIGH,
                "title": "CSRF on Checkout",
                "description": "Checkout may be vulnerable to CSRF attacks",
                "component": "Checkout Form",
                "owasp": "A01:2021 - Broken Access Control",
                "test": "Verify CSRF protection on checkout submission",
                "remediation": "Implement CSRF tokens, same-site cookies",
                "cwe": "CWE-352",
            },
            {
                "type": VulnerabilityType.BROKEN_ACCESS_CONTROL,
                "severity": SeverityLevel.HIGH,
                "title": "IDOR in Order Access",
                "description": "Users may access other users' order details",
                "component": "Order Display",
                "owasp": "A01:2021 - Broken Access Control",
                "test": "Test accessing orders with different order IDs",
                "remediation": "Implement proper authorization checks",
                "cwe": "CWE-639",
            },
        ],
        "search": [
            {
                "type": VulnerabilityType.INJECTION,
                "severity": SeverityLevel.CRITICAL,
                "title": "SQL Injection in Search",
                "description": "Search query may be vulnerable to SQL injection",
                "component": "Search Endpoint",
                "owasp": "A03:2021 - Injection",
                "test": "Test SQL injection payloads in search query",
                "remediation": "Use parameterized queries, sanitize input",
                "cwe": "CWE-89",
            },
            {
                "type": VulnerabilityType.XSS,
                "severity": SeverityLevel.HIGH,
                "title": "Reflected XSS in Search Results",
                "description": "Search query may be reflected without sanitization",
                "component": "Search Results Display",
                "owasp": "A03:2021 - Injection",
                "test": "Test XSS payloads in search, verify output encoding",
                "remediation": "Encode all output, use Content-Security-Policy",
                "cwe": "CWE-79",
            },
            {
                "type": VulnerabilityType.RATE_LIMITING,
                "severity": SeverityLevel.MEDIUM,
                "title": "Search DoS Vulnerability",
                "description": "Search endpoint may lack rate limiting",
                "component": "Search API",
                "owasp": "A05:2021 - Security Misconfiguration",
                "test": "Test rate limiting on search requests",
                "remediation": "Implement rate limiting, query complexity limits",
                "cwe": "CWE-770",
            },
            {
                "type": VulnerabilityType.SENSITIVE_DATA_EXPOSURE,
                "severity": SeverityLevel.MEDIUM,
                "title": "Search Results Data Leakage",
                "description": "Search may expose sensitive data in results",
                "component": "Search Results",
                "owasp": "A01:2021 - Broken Access Control",
                "test": "Verify search results respect access controls",
                "remediation": "Filter results based on user permissions",
                "cwe": "CWE-200",
            },
        ],
        "profile": [
            {
                "type": VulnerabilityType.BROKEN_ACCESS_CONTROL,
                "severity": SeverityLevel.CRITICAL,
                "title": "IDOR in Profile Access",
                "description": "Users may access other users' profiles",
                "component": "Profile Endpoint",
                "owasp": "A01:2021 - Broken Access Control",
                "test": "Test accessing profiles with different user IDs",
                "remediation": "Implement proper authorization checks",
                "cwe": "CWE-639",
            },
            {
                "type": VulnerabilityType.XSS,
                "severity": SeverityLevel.HIGH,
                "title": "Stored XSS in Profile Fields",
                "description": "Profile data may contain XSS payloads",
                "component": "Profile Display",
                "owasp": "A03:2021 - Injection",
                "test": "Test XSS payloads in all profile fields",
                "remediation": "Sanitize input, encode output",
                "cwe": "CWE-79",
            },
            {
                "type": VulnerabilityType.CSRF,
                "severity": SeverityLevel.HIGH,
                "title": "CSRF on Profile Update",
                "description": "Profile updates may lack CSRF protection",
                "component": "Profile Update Form",
                "owasp": "A01:2021 - Broken Access Control",
                "test": "Verify CSRF token on profile update",
                "remediation": "Implement CSRF tokens",
                "cwe": "CWE-352",
            },
            {
                "type": VulnerabilityType.AUTH_FAILURES,
                "severity": SeverityLevel.HIGH,
                "title": "Password Change Without Verification",
                "description": "Password may be changed without current password",
                "component": "Password Change",
                "owasp": "A07:2021 - Auth Failures",
                "test": "Verify current password required for change",
                "remediation": "Require current password for sensitive changes",
                "cwe": "CWE-620",
            },
            {
                "type": VulnerabilityType.SENSITIVE_DATA_EXPOSURE,
                "severity": SeverityLevel.MEDIUM,
                "title": "Sensitive Data in Profile Response",
                "description": "API may return sensitive data in profile",
                "component": "Profile API",
                "owasp": "A02:2021 - Cryptographic Failures",
                "test": "Check for password hashes, tokens in response",
                "remediation": "Never expose sensitive data in responses",
                "cwe": "CWE-200",
            },
        ],
    }

    def __init__(self):
        """Initialize the scanner."""
        self._scan_count = 0
        self._vulnerability_count = 0

    def scan(
        self,
        page_type: str,
        feature: str = "Feature",
        include_low: bool = True,
    ) -> ScanResult:
        """Scan a page type for potential vulnerabilities."""
        self._scan_count += 1

        vulnerabilities = []
        vuln_defs = self.VULNERABILITY_MAP.get(page_type, [])

        for vuln_def in vuln_defs:
            # Skip low severity if not requested
            if not include_low and vuln_def["severity"] == SeverityLevel.LOW:
                continue

            self._vulnerability_count += 1
            vulnerability = Vulnerability(
                id=f"VULN-{self._vulnerability_count:04d}",
                vulnerability_type=vuln_def["type"],
                severity=vuln_def["severity"],
                title=vuln_def["title"],
                description=vuln_def["description"],
                affected_component=vuln_def["component"],
                owasp_reference=vuln_def["owasp"],
                test_required=vuln_def["test"],
                remediation=vuln_def["remediation"],
                cwe_id=vuln_def.get("cwe"),
            )
            vulnerabilities.append(vulnerability)

        # Calculate counts
        critical_count = sum(1 for v in vulnerabilities if v.severity == SeverityLevel.CRITICAL)
        high_count = sum(1 for v in vulnerabilities if v.severity == SeverityLevel.HIGH)
        medium_count = sum(1 for v in vulnerabilities if v.severity == SeverityLevel.MEDIUM)
        low_count = sum(1 for v in vulnerabilities if v.severity == SeverityLevel.LOW)

        # Calculate risk score (weighted sum)
        risk_score = (
            critical_count * 10 +
            high_count * 5 +
            medium_count * 2 +
            low_count * 1
        ) / max(len(vulnerabilities), 1)

        return ScanResult(
            page_type=page_type,
            feature=feature,
            scanned_at=datetime.now(),
            vulnerabilities=vulnerabilities,
            total_found=len(vulnerabilities),
            critical_count=critical_count,
            high_count=high_count,
            medium_count=medium_count,
            low_count=low_count,
            risk_score=risk_score,
        )

    def get_vulnerabilities_by_severity(
        self,
        result: ScanResult,
        severity: SeverityLevel,
    ) -> List[Vulnerability]:
        """Filter vulnerabilities by severity."""
        return [v for v in result.vulnerabilities if v.severity == severity]

    def get_vulnerabilities_by_type(
        self,
        result: ScanResult,
        vuln_type: VulnerabilityType,
    ) -> List[Vulnerability]:
        """Filter vulnerabilities by type."""
        return [v for v in result.vulnerabilities if v.vulnerability_type == vuln_type]

    def format_report(self, result: ScanResult) -> str:
        """Format scan result as a report."""
        lines = [
            "=" * 70,
            f"  SECURITY VULNERABILITY SCAN: {result.feature}",
            "=" * 70,
            "",
            f"  Page Type: {result.page_type}",
            f"  Scanned:   {result.scanned_at.strftime('%Y-%m-%d %H:%M:%S')}",
            f"  Risk Score: {result.risk_score:.1f}/10",
            "",
            "-" * 70,
            "  SUMMARY",
            "-" * 70,
            f"  Total Vulnerabilities: {result.total_found}",
            f"    游댮 Critical: {result.critical_count}",
            f"    游 High:     {result.high_count}",
            f"    游리 Medium:   {result.medium_count}",
            f"    游릭 Low:      {result.low_count}",
            "",
        ]

        # Group by severity
        for severity in [SeverityLevel.CRITICAL, SeverityLevel.HIGH, SeverityLevel.MEDIUM, SeverityLevel.LOW]:
            vulns = self.get_vulnerabilities_by_severity(result, severity)
            if vulns:
                icon = {"critical": "游댮", "high": "游", "medium": "游리", "low": "游릭"}[severity.value]
                lines.extend([
                    "-" * 70,
                    f"  {icon} {severity.value.upper()} VULNERABILITIES",
                    "-" * 70,
                ])
                for v in vulns:
                    lines.extend([
                        f"  [{v.id}] {v.title}",
                        f"    Component: {v.affected_component}",
                        f"    OWASP: {v.owasp_reference}",
                        f"    CWE: {v.cwe_id or 'N/A'}",
                        f"    Test: {v.test_required}",
                        f"    Fix: {v.remediation[:60]}...",
                        "",
                    ])

        lines.append("=" * 70)
        return "\n".join(lines)


def create_scanner() -> VulnerabilityScanner:
    """Create a vulnerability scanner instance."""
    return VulnerabilityScanner()
